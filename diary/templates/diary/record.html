{% extends 'base.html' %}
{% block content %}

<!-- =========================
     1) ページタイトル
========================= -->
<h2 class="record-title">
  {% if display_date %}
    {{ display_date|date:"Y年n月j日" }} の記録
  {% else %}
    記録
  {% endif %}
</h2>

<!-- =========================
     2) フォーム本体
========================= -->
<form method="post" enctype="multipart/form-data" class="record-form" novalidate>
  {% csrf_token %}

  <!-- 2-1) 上段：写真あり→2カラム / 写真なし→1カラムレイアウト -->
  <div class="{% if form.instance and form.instance.photo %}top-grid{% else %}single-col{% endif %}">

    <!-- 左カラム：日付 / 気分 / メモ / （写真未登録時の写真） -->
    <div class="left-col">

      <!-- 日付 -->
      <div class="form-row">
        <label for="{{ form.date.id_for_label }}">日付</label>
        {{ form.date }}
      </div>

      <!-- 気分（●のみ）＋ ？ヘルプ -->
      <div class="form-row">
        <div class="field-header">
          <label for="mood">気分</label>
          <span class="help" onclick="openMoodModal()">？</span>
        </div>
        <select id="mood" name="mood">
          <option value="" data-color="" style="color: black;">（未選択）</option>
          {% for m in moods %}
            <option
              value="{{ m.id }}"
              data-color="{{ m.color }}"
              style="color: {{ m.color }};"
              {% if selected_mood_id == m.id|stringformat:"s" %}selected{% endif %}
            >●</option>
          {% endfor %}
        </select>
      </div>

      <!-- メモ -->
      <div class="form-row">
        <label for="{{ form.note.id_for_label }}">メモ</label>
        {{ form.note }}
      </div>

      {% if not form.instance or not form.instance.photo %}
      <!-- 写真（未登録時はここで登録） -->
      <div class="form-row photo-create-row">
        <label for="photo-input">写真</label>
        <input type="file" id="photo-input" name="photo" accept="image/*">

        <!-- 新規選択プレビュー（初期は非表示） -->
        <div id="photo-preview-wrap" class="record-preview" aria-hidden="true" style="display:none;background:transparent;border:0;padding:0;box-shadow:none;outline:0;">
          <div class="photo-preview-title" style="font-size:12px;color:#555;display:none;">写真プレビュー</div>

          <!-- プレビュー画像（枠ゼロ・角丸のみ） -->
          <img id="photo-preview" alt=""
              style="display:none;max-width:240px;max-height:160px;object-fit:cover;border:0;outline:0;box-shadow:none;border-radius:6px;">

          <!-- 新規選択後だけ出す操作ボタン（表示/非表示はCSSで制御） -->
          <div id="photo-new-actions" class="photo-actions">
            <button type="button" class="btn btn-danger-outline" id="btn-remove-photo">
              写真削除
            </button>

            <!-- 写真変更は “選び直し専用”（nameは付けない） -->
            <label class="btn btn-secondary filebtn">
              写真変更
              <input type="file" id="photo-reselect" accept="image/*" class="hidden-file">
            </label>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- 右カラム：現在の写真（ある場合のみ） -->
    <div class="right-col">
      {% if form.instance and form.instance.photo %}
        <div class="current-photo">
          <div class="cp-title">現在の写真</div>
          <img src="{{ form.instance.photo.url }}" alt="" class="cp-img">

          <!-- 写真操作 -->
          <div class="photo-actions">
            <button type="button" class="btn btn-danger-outline" data-photo-delete>
              写真削除
            </button>

            <label class="btn btn-secondary filebtn">
              写真変更
              <input type="file" name="photo" id="photo-input-existing" accept="image/*" class="hidden-file">
            </label>
          </div>

          <!-- 既存の差し替えプレビュー（必要なら使う） -->
          <div id="photo-preview-wrap-existing" class="preview-wrap">
            <img id="photo-preview-existing" alt="" class="pv-img">
          </div>
        </div>
      {% endif %}
    </div>

  </div>

  <!-- 2-2) ボタン -->
  <div class="button-row">
    <button type="submit" class="btn btn-primary">保存</button>
    {% if has_record %}
      <a href="#"
         class="btn btn-danger"
         data-delete-url="{% url 'record_delete' form.instance.id %}">
        記録削除
      </a>
    {% endif %}
  </div>
</form>

<!-- =========================
     3) 気分の説明モーダル
========================= -->
<div id="moodModal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" onclick="closeMoodModal()" aria-hidden="true"></div>
  <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="moodTitle">
    <h3 id="moodTitle">気分の色とは</h3>
    <p>
      気分を色で表すことで、その日を直感的に記録できます。<br><br>
      言葉にしにくい日や、気軽に記録したい日にもおすすめです。
    </p>
    <div class="modal-actions">
      <button type="button" class="btn" onclick="closeMoodModal()">閉じる</button>
    </div>
  </div>
</div>

<!-- =========================
     4) ページ専用スタイル
========================= -->
<style>
/* ---- タイトル ---- */
.record-title { text-align: center; }

/* ---- レイアウト ---- */
.top-grid { display: flex; gap: 16px; align-items: flex-start; margin-bottom: 8px; }

/* 1カラム時（写真未登録）は左基準 → 後で中央に戻す */
.single-col { display: flex; flex-direction: column; align-items: stretch; gap: 16px; }
.left-col  { flex: 0 0 var(--field-width, 520px); max-width: var(--field-width, 520px); }
.right-col { flex: 0 0 auto; }
.single-col .left-col { align-self: stretch; display: flex; flex-direction: column; align-items: flex-start; }
.single-col .left-col .form-row { width: 100%; max-width: var(--field-width, 520px); margin-left: 0; text-align: left; }

/* 気分モーダル見出し */
#moodTitle { display: inline-block; border-bottom: 2px solid #888; padding-bottom: 2px; }

/* フィールド共通 */
input[type="date"], #mood { height: 40px; box-sizing: border-box; }

/* 気分セレクト（サイズ） */
#mood { font-size: 20px; text-align: center; }
#mood option { font-size: 30px; }
#mood option[value=""] { font-size: 20px; }

/* メモ↔写真の縦間隔を詰める */
.left-col .form-row:last-of-type { margin-bottom: 8px; }

/* 右カラム：既存写真の見た目 */
.current-photo .cp-title { font-size:12px; color:#555; margin-bottom:6px; }
.current-photo .cp-img {
  width: 480px; max-width: 90vw; height: 320px;
  object-fit: cover; border-radius: 8px; display: block;
}

/* 写真操作ボタン（右/左どちらでも共通） */
.photo-actions { display: flex; gap: 12px; align-items: center; margin-top: 8px; }

/* 下部のアクションボタン列（保存／記録削除） */
.button-row { display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 16px; }

/* ==== 新規選択プレビュー（枠ゼロ & 左寄せ） ==== */

/* 写真入力行の子要素は左端で揃える（プレビューは左下に寄せる） */
.photo-create-row { align-items: flex-start !important; }
.photo-create-row > label,
.photo-create-row > #photo-input,
.photo-create-row > #photo-preview-wrap,
.photo-create-row > #photo-new-actions {
  align-self: flex-start !important;
  margin-left: 0 !important;
  text-align: left !important;
}

/* 初期は完全非表示（JSで .is-open を付けた時だけ出す） */
#photo-preview-wrap {
  display: none !important;
  background: transparent !important;
  border: 0 !important;
  padding: 0 !important;
  box-shadow: none !important;
  outline: 0 !important;
  margin-top: 8px;
}

/* 画像選択後にだけ表示（縦並び・左寄せ） */
#photo-preview-wrap.is-open {
  display: inline-flex !important;
  flex-direction: column !important;
  align-items: flex-start !important;
}

/* タイトルは選択後のみ表示 */
.photo-preview-title { display: none !important; font-size: 12px; color: #555; }
#photo-preview-wrap.is-open .photo-preview-title { display: block !important; }

/* 画像は src が付いた時だけ表示。枠/影/アウトラインを完全に無効化 */
#photo-preview {
  display: none !important;
  max-width: 240px;
  max-height: 160px;
  object-fit: cover;
  border-radius: 6px;
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
  background: transparent !important;
}
#photo-preview[src] { display: block !important; }

/* ボタン行は選択後だけ表示（左寄せ） */
#photo-new-actions { display: none !important; }
#photo-preview-wrap.is-open #photo-new-actions {
  display: flex !important;
  gap: 12px !important;
  margin-top: 8px !important;
  justify-content: flex-start !important;
}

/* === 全体を中央寄せに戻す（プレビューは左寄せのまま） === */
.single-col { align-items: center !important; }
.single-col .left-col { align-self: center !important; display: flex; flex-direction: column; align-items: stretch !important; }
.single-col .left-col .form-row { width: 100%; max-width: var(--field-width, 520px); }
</style>



{% if reset_photo %}
<script>window.RESET_UPLOAD = true;</script>
{% else %}
<script>window.RESET_UPLOAD = false;</script>
{% endif %}



<!-- =========================
     5) ページ専用スクリプト
========================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  /* ================================
 * 5-1) 写真プレビュー（未登録→新規選択時）
 * ================================ */
  const input     = document.getElementById("photo-input");
  const wrap      = document.getElementById("photo-preview-wrap");
  const img       = document.getElementById("photo-preview");
  const actions   = document.getElementById("photo-new-actions");
  const removeBtn = document.getElementById("btn-remove-photo");
  const reselect  = document.getElementById("photo-reselect");

  const closePreview = () => {
    if (img) {
      img.removeAttribute("src");
    }
    if (wrap) {
      wrap.classList.remove("is-open");
      wrap.setAttribute("aria-hidden", "true");
      wrap.style.removeProperty("display");
    }
    if (actions) actions.style.removeProperty("display");
    if (input) input.style.display = "block";
  };

  const openPreview = (file) => {
    if (!file) return closePreview();
    if (img) {
      img.src = URL.createObjectURL(file);
    }
    if (wrap) {
      wrap.classList.add("is-open");
      wrap.setAttribute("aria-hidden", "false");
      wrap.style.removeProperty("display");
    }
    if (actions) actions.style.removeProperty("display");
    if (input) input.style.display = "none";
  };

  if (window.RESET_UPLOAD) {
    if (input) input.value = "";
    if (reselect) reselect.value = "";
    closePreview();
  }

  if (wrap) closePreview();
  const initialFile = (input && input.files && input.files[0]) ? input.files[0] : null;
  if (initialFile) openPreview(initialFile);

  if (input) {
    input.addEventListener("change", () => {
      const file = (input.files && input.files[0]) ? input.files[0] : null;
      if (file) openPreview(file);
      else closePreview();
    });
  }

  // 写真削除：全部クリア、閉じる
  if (removeBtn) {
    removeBtn.addEventListener("click", () => {
      if (input)    input.value = "";
      if (reselect) reselect.value = "";
      closePreview();
    });
  }

  // 写真変更
  if (reselect) {
    reselect.addEventListener("change", () => {
      const file = (reselect.files && reselect.files[0]) ? reselect.files[0] : null;
      if (!file || !input) return;
      const dt = new DataTransfer();
      dt.items.add(file);
      input.files = dt.files; 
      openPreview(file);
    });
  }


  /* ================================
   * 5-2) 気分セレクト：色反映
   * ================================ */
  const sel = document.getElementById("mood");
  if (sel) {
    const paintOptionColors = () => {
      for (const opt of sel.options) {
        opt.style.color = opt.value ? (opt.dataset.color || opt.style.color || "") : "black";
      }
    };
    const applyColorToSelectFace = () => {
      const opt = sel.options[sel.selectedIndex];
      const value = opt ? opt.value : "";
      sel.style.color = value ? (opt.dataset.color || opt.style.color || "black") : "black";
    };
    paintOptionColors();
    applyColorToSelectFace();
    sel.addEventListener("change", () => { paintOptionColors(); applyColorToSelectFace(); });
    sel.addEventListener("focus",  paintOptionColors);
    sel.addEventListener("mousedown", paintOptionColors);
    sel.addEventListener("keyup",  paintOptionColors);
  }

  /* ================================
   * 5-3) 既存写真の削除モーダル（右カラム）
   * ================================ */
  document.querySelectorAll('[data-photo-delete]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const m = document.getElementById('photo-delete-modal');
      if (!m) return;
      m.classList.add('show');
      m.setAttribute('aria-hidden','false');
      const f = document.getElementById('photo-delete-form');
      if (f) f.action = window.location.href;
    });
  });
});

/* ================================
 * 5-4) 気分説明モーダル open/close（グローバル）
 * ================================ */
function openMoodModal() {
  const moodModal = document.getElementById("moodModal");
  if (!moodModal) return;
  moodModal.classList.add("show");
  moodModal.setAttribute("aria-hidden", "false");
}
function closeMoodModal() {
  const moodModal = document.getElementById("moodModal");
  if (!moodModal) return;
  moodModal.classList.remove("show");
  moodModal.setAttribute("aria-hidden", "true");
}
</script>


{% endblock %}
