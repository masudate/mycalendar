{% extends 'base.html' %}
{% block content %}

<!-- =========================
     1) ページタイトル
========================= -->
<h2 class="record-title">
  {% if display_date %}
    {{ display_date|date:"Y年n月j日" }} の記録
  {% else %}
    記録
  {% endif %}
</h2>

<!-- =========================
     2) フォーム本体
========================= -->
<form method="post" enctype="multipart/form-data" class="record-form">
  {% csrf_token %}

  <!-- 2-1) 上段：写真あり→2カラム / 写真なし→1カラムレイアウト -->
  <div class="{% if form.instance and form.instance.photo %}top-grid{% else %}single-col{% endif %}">

    <!-- 左カラム：日付 / 気分 / メモ / （写真未登録時の写真） -->
    <div class="left-col">

      <!-- 日付 -->
      <div class="form-row">
        <label for="{{ form.date.id_for_label }}">日付</label>
        {{ form.date }}
      </div>

      <!-- 気分（●のみ）＋ ？ヘルプ -->
      <div class="form-row">
        <div class="field-header">
          <label for="mood">気分</label>
          <span class="help" onclick="openMoodModal()">？</span>
        </div>
        <select id="mood" name="mood">
          <option value="" data-color="" style="color: black;">（未選択）</option>
          {% for m in moods %}
            <option
              value="{{ m.id }}"
              data-color="{{ m.color }}"
              style="color: {{ m.color }};"
              {% if selected_mood_id == m.id|stringformat:"s" %}selected{% endif %}
            >●</option>
          {% endfor %}
        </select>
      </div>

      <!-- メモ -->
      <div class="form-row">
        <label for="{{ form.note.id_for_label }}">メモ</label>
        {{ form.note }}
      </div>

      {% if not form.instance or not form.instance.photo %}
      <!-- 写真（未登録時はここで登録） -->
      <div class="form-row photo-create-row">
        <label for="{{ form.photo.id_for_label }}">写真</label>
        <input type="file" name="photo" id="photo-input" accept="image/*">

        <!-- 新規選択プレビュー -->
        <div id="photo-preview-wrap" style="display:none; margin-top:8px;">
          <div style="font-size:12px; color:#555;">選択した画像のプレビュー</div>
          <img id="photo-preview" alt="" style="max-width:240px; max-height:160px; object-fit:cover; border-radius:6px;">
        </div>
      </div>
      {% endif %}
    </div>

    <!-- 右カラム：現在の写真（ある場合のみ） -->
    <div class="right-col">
      {% if form.instance and form.instance.photo %}
        <div class="current-photo">
          <div class="cp-title">現在の写真</div>
          <img src="{{ form.instance.photo.url }}" alt="" class="cp-img">

          <!-- 写真操作 -->
          <div class="photo-actions">
            <button type="button" class="btn btn-danger-outline" data-photo-delete>
              写真を削除
            </button>

            <label class="filebtn">
              写真を変更
              <input type="file" name="photo" id="photo-input" accept="image/*" class="hidden-file">
            </label>
          </div>

          <!-- 差し替え時プレビュー -->
          <div id="photo-preview-wrap" class="preview-wrap">
            <img id="photo-preview" alt="" class="pv-img">
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- 2-2) アクションボタン -->
  <div class="button-row">
    <button type="submit" class="btn btn-primary">保存する</button>
    {% if has_record %}
      <a href="#"
         class="btn btn-danger"
         data-delete-url="{% url 'record_delete' form.instance.id %}">
        記録削除
      </a>
    {% endif %}
  </div>
</form>

<!-- =========================
     3) 気分の説明モーダル
========================= -->
<div id="moodModal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" onclick="closeMoodModal()" aria-hidden="true"></div>
  <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="moodTitle">
    <h3 id="moodTitle">気分の色とは</h3>
    <p>
      気分を色で表すことで、その日を直感的に記録できます。<br><br>
      言葉にしにくい日や、気軽に記録したい日にもおすすめです。
    </p>
    <div class="modal-actions">
      <button type="button" class="btn" onclick="closeMoodModal()">閉じる</button>
    </div>
  </div>
</div>

<!-- =========================
     4) ページ専用スタイル
========================= -->
<style>
/* ---- タイトル ---- */
.record-title { text-align: center; }

/* ---- レイアウト ---- */
.top-grid { display: flex; gap: 16px; align-items: flex-start; margin-bottom: 8px; }
.single-col { display: flex; flex-direction: column; align-items: center; gap: 16px; }

/* 左カラムは共通幅 */
.left-col  { flex: 0 0 var(--field-width, 520px); max-width: var(--field-width, 520px); }
.right-col { flex: 0 0 auto; }

/* single-col 時も左カラム内の form-row は同じ幅・左揃え */
.single-col .left-col .form-row { width: 100%; max-width: var(--field-width, 520px); }

/* ---- 気分モーダル見出し（下線グレー・文字幅だけ） ---- */
#moodTitle {
  display: inline-block;
  border-bottom: 2px solid #888;
  padding-bottom: 2px;
}

/* ---- フィールド共通（高さ揃え） ---- */
input[type="date"],
#mood { height: 40px; box-sizing: border-box; }

/* ---- 気分セレクト（サイズ調整＋未選択だけ小さめ） ---- */
#mood { font-size: 20px; text-align: center; }
#mood option { font-size: 30px; } /* プルダウン内の● */
#mood option[value=""] { font-size: 20px; }/* 未選択は控えめ */

/* ---- メモ↔写真の縦間隔を詰める ---- */
.left-col .form-row:last-of-type { margin-bottom: 8px; }

/* ---- 現在の写真の見た目 ---- */
.current-photo .cp-title { font-size:12px; color:#555; margin-bottom:6px; }
.current-photo .cp-img {
  width: 480px; max-width: 90vw; height: 320px;
  object-fit: cover; border-radius: 8px; display: block;
}
.photo-actions { display: flex; gap: 12px; align-items: center; margin-top: 8px; }

/* ---- アクションボタン行（常に中央） ---- */
.button-row {
  display: flex; justify-content: center; align-items: center;
  gap: 12px; margin-top: 16px;
}
</style>

<!-- =========================
     5) ページ専用スクリプト
========================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  /* 5-1) 写真プレビュー */
  const input = document.getElementById("photo-input");
  const wrap  = document.getElementById("photo-preview-wrap");
  const img   = document.getElementById("photo-preview");

  if (input) {
    input.addEventListener("change", () => {
      const file = input.files && input.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        img.src = url;
        wrap.style.display = "block";
      } else {
        img.removeAttribute("src");
        wrap.style.display = "none";
      }
    });
  }

  /* 5-2) 気分セレクト：色反映 */
  const sel = document.getElementById("mood");
  if (sel) {
    function paintOptionColors() {
      for (const opt of sel.options) {
        if (!opt.value) {
          opt.style.color = "black";
        } else {
          opt.style.color = opt.dataset.color || opt.style.color || "";
        }
      }
    }
    function applyColorToSelectFace() {
      const opt = sel.options[sel.selectedIndex];
      const value = opt ? opt.value : "";
      sel.style.color = value ? (opt.dataset.color || opt.style.color || "black") : "black";
    }
    paintOptionColors();
    applyColorToSelectFace();
    sel.addEventListener("change", () => { paintOptionColors(); applyColorToSelectFace(); });
    sel.addEventListener("focus", paintOptionColors);
    sel.addEventListener("mousedown", paintOptionColors);
    sel.addEventListener("keyup", paintOptionColors);
  }

  /* 5-3) 写真削除モーダルは base.html 側の要素・JSを利用 */
  document.querySelectorAll('[data-photo-delete]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const m = document.getElementById('photo-delete-modal');
      if (!m) return;
      m.classList.add('show');
      m.setAttribute('aria-hidden','false');
      const f = document.getElementById('photo-delete-form');
      if (f) f.action = window.location.href;
    });
  });
});

/* 5-4) 気分説明モーダル open/close */
function openMoodModal() {
  const moodModal = document.getElementById("moodModal");
  moodModal.classList.add("show");
  moodModal.setAttribute("aria-hidden", "false");
}
function closeMoodModal() {
  const moodModal = document.getElementById("moodModal");
  moodModal.classList.remove("show");
  moodModal.setAttribute("aria-hidden", "true");
}
</script>

{% endblock %}
