{% extends 'base.html' %}
{% block content %}

<!-- =========================
     1) ページタイトル
========================= -->
<h2 class="record-title">
  {% if display_date %}
    {{ display_date|date:"Y年n月j日" }} の記録
  {% else %}
    記録
  {% endif %}
</h2>

<!-- =========================
     2) フォーム本体
========================= -->
<form method="post" enctype="multipart/form-data" class="record-form" novalidate>
  {% csrf_token %}

  <!-- 2-1) 上段：写真あり→2カラム / 写真なし→1カラムレイアウト -->
  <div class="{% if current_photo %}top-grid{% else %}single-col{% endif %}">

    <!-- 左カラム：日付 / 気分 / メモ / （写真未登録時の写真） -->
    <div class="left-col">

      <!-- 日付 -->
      <div class="form-row">
        <label for="{{ form.date.id_for_label }}">日付</label>
        {{ form.date }}
      </div>

      <!-- 気分（●のみ）＋ ？ヘルプ -->
      <div class="form-row">
        <div class="field-header">
          <label for="mood">気分</label>
          <span class="help" onclick="openMoodModal()">？</span>
        </div>

        <!-- ネイティブ select（送信用）。後でJSが視覚的に隠す -->
        <select id="mood" name="mood">
          <option value="" data-color="">（未選択）</option>
          {% for m in moods %}
            <option
              value="{{ m.id }}"
              data-color="{{ m.color }}"
              {% if selected_mood_id == m.id|stringformat:"s" %}selected{% endif %}
            >{{ m.name|default:"色" }}</option>
          {% endfor %}
        </select>

        <!-- 色選択ドロップダウン -->
        <div class="mood-select" data-enhance="mood">
          <button type="button" class="mood-trigger" aria-haspopup="listbox" aria-expanded="false">
            <span class="mood-dot" aria-hidden="true"></span>
            <span class="mood-label">選択してください</span>
          </button>
          <div class="mood-panel" role="listbox" tabindex="-1" hidden>
            {% for m in moods %}
              <button type="button"
                      role="option"
                      class="mood-option"
                      data-value="{{ m.id }}"
                      data-color="{{ m.color }}"
                      aria-selected="false">
                <span class="mood-dot" aria-hidden="true" style="--c: {{ m.color }};"></span>
              </button>
            {% endfor %}
          </div>
        </div>
      </div>


      <!-- メモ -->
      <div class="form-row">
        <label for="{{ form.note.id_for_label }}">メモ</label>
        {{ form.note }}
      </div>

      {% if not form.instance or not form.instance.photo %}
      <!-- 写真（未登録時） -->
      <div class="form-row photo-create-row">
        <label for="photo-input">写真</label>
        <input type="file" id="photo-input" name="photo" accept="image/*" class="u-vh">
        <label for="photo-input" class="btn btn-secondary filebtn">ファイルを選択</label>

        <!-- 新規選択プレビュー（初期は非表示） -->
        <div id="photo-preview-wrap" 
          class="record-preview" 
          aria-hidden="{% if preview_data_uri %}false{% else %}true{% endif %}"
          style="background:transparent;border:0;padding:0;box-shadow:none;outline:0;{% if not preview_data_uri %}display:none;{% endif %}">
          <div class="photo-preview-title" style="font-size:12px;color:#555;display:none;">写真プレビュー</div>

          <!-- プレビュー画像（枠ゼロ・角丸） -->
          <img id="photo-preview" alt=""
              {% if preview_data_uri %}
              src="{{ preview_data_uri }}"
              style="display:block;max-width:240px;max-height:160px;object-fit:cover;border:0;outline:0;box-shadow:none;border-radius:6px;"
              {% else %}
              style="display:none;max-width:240px;max-height:160px;object-fit:cover;border:0;outline:0;box-shadow:none;border-radius:6px;"
              {% endif %}>

          <!-- 写真選択後操作ボタン -->
          <div id="photo-new-actions" class="photo-actions">
            <button type="button" class="btn btn-danger-outline" id="btn-remove-photo">
              写真削除
            </button>

            <!-- 写真変更は “選び直し専用” -->
            <label class="btn btn-secondary filebtn">
              写真変更
              <input type="file" id="photo-reselect" accept="image/*" class="hidden-file">
            </label>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- 右カラム：現在の写真（ある場合のみ） -->
    <div class="right-col">
      {% if current_photo %}
        <div class="current-photo">
          <div class="cp-title">現在の写真</div>
          <img src="{{ current_photo.url }}" alt="" class="cp-img">

          <!-- 写真操作 -->
          <div class="photo-actions">
            <button type="button" class="btn btn-danger-outline" data-photo-delete>
              写真削除
            </button>

            <label class="btn btn-secondary filebtn">
              写真変更
              <input type="file" name="photo" id="photo-input-existing" accept="image/*" class="hidden-file">
            </label>
          </div>
        </div>
      {% endif %}
    </div>

  </div>

  <!-- 2-2) ボタン -->
  <div class="button-row">
    <button type="submit" class="btn btn-primary">保存</button>
    {% if has_record %}
      <a href="#"
         class="btn btn-danger"
         data-delete-url="{% url 'record_delete' form.instance.id %}">
        記録削除
      </a>
    {% endif %}
  </div>
</form>

<!-- =========================
     3) 気分の説明モーダル
========================= -->
<div id="moodModal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" onclick="closeMoodModal()" aria-hidden="true"></div>
  <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="moodTitle">
    <h3 id="moodTitle">気分の色とは</h3>
    <p>
     色はご自由に意味づけ可能です。<br><br>
      その日の気分に近い色を1つ選んで記録します。<br><br>
      選んだ色はカレンダーに表示され、気分の変化を振り返ることができます。 
    </p>
    <div class="modal-actions">
      <button type="button" class="btn" onclick="closeMoodModal()">閉じる</button>
    </div>
  </div>
</div>

<!-- =========================
     4) ページ専用スタイル
========================= -->
<style>
/* ---- タイトル ---- */
.record-title { text-align: center; }

/* ---- レイアウト ---- */
.top-grid { display: flex; gap: 16px; align-items: flex-start; margin-bottom: 8px; }

/* 1カラム時（写真未登録）は左基準 → 後で中央に戻す */
.single-col { display: flex; flex-direction: column; align-items: stretch; gap: 16px; }
.left-col  { flex: 0 0 var(--field-width, 520px); max-width: var(--field-width, 520px); }
.right-col { flex: 0 0 auto; }
.single-col .left-col { align-self: stretch; display: flex; flex-direction: column; align-items: flex-start; }
.single-col .left-col .form-row { width: 100%; max-width: var(--field-width, 520px); margin-left: 0; text-align: left; }

/* 気分モーダル見出し */
#moodTitle { display: inline-block; border-bottom: 2px solid #888; padding-bottom: 2px; }

/* フィールド共通 */
input[type="date"], #mood { height: 40px; box-sizing: border-box; }

/* 気分セレクト（サイズ） */
#mood { font-size: 20px; text-align: center; }
#mood option { font-size: 30px; }
#mood option[value=""] { font-size: 20px; }

/* メモ↔写真の縦間隔を詰める */
.left-col .form-row:last-of-type { margin-bottom: 8px; }

/* 右カラム：既存写真の見た目 */
.current-photo .cp-title { font-size:12px; color:#555; margin-bottom:6px; }
.current-photo .cp-img {
  width: 480px; max-width: 90vw; height: 320px;
  object-fit: cover; border-radius: 8px; display: block;
}

/* 写真操作ボタン（右/左どちらでも共通） */
.photo-actions { display: flex; gap: 12px; align-items: center; margin-top: 8px; }

/* 下部のアクションボタン列（保存／記録削除） */
.button-row { display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 16px; }

/* ==== 新規選択プレビュー（枠ゼロ & 左寄せ） ==== */

/* 写真入力行の子要素は左端で揃える（プレビューは左下に寄せる） */
.photo-create-row { align-items: flex-start !important; }
.photo-create-row > label,
.photo-create-row > #photo-input,
.photo-create-row > #photo-preview-wrap,
.photo-create-row > #photo-new-actions {
  align-self: flex-start !important;
  margin-left: 0 !important;
  text-align: left !important;
}

/* 初期は完全非表示（JSで .is-open を付けた時だけ出す） */
#photo-preview-wrap {
  display: none !important;
  background: transparent !important;
  border: 0 !important;
  padding: 0 !important;
  box-shadow: none !important;
  outline: 0 !important;
  margin-top: 8px;
}

/* 画像選択後にだけ表示（縦並び・左寄せ） */
#photo-preview-wrap.is-open {
  display: inline-flex !important;
  flex-direction: column !important;
  align-items: flex-start !important;
}

/* タイトルは選択後のみ表示 */
.photo-preview-title { display: none !important; font-size: 12px; color: #555; }
#photo-preview-wrap.is-open .photo-preview-title { display: block !important; }

/* 画像は src が付いた時だけ表示。枠/影/アウトラインを完全に無効化 */
#photo-preview {
  display: none !important;
  max-width: 240px;
  max-height: 160px;
  object-fit: cover;
  border-radius: 6px;
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
  background: transparent !important;
}
#photo-preview[src] { display: block !important; }

/* ボタン行は選択後だけ表示（左寄せ） */
#photo-new-actions { display: none !important; }
#photo-preview-wrap.is-open #photo-new-actions {
  display: flex !important;
  gap: 12px !important;
  margin-top: 8px !important;
  justify-content: flex-start !important;
}

.filebtn {
  cursor: pointer;
  user-select: none;
}

/* === 全体を中央寄せ（プレビューは左寄せのまま） === */
.single-col { align-items: center !important; }
.single-col .left-col { align-self: center !important; display: flex; flex-direction: column; align-items: stretch !important; }
.single-col .left-col .form-row { width: 100%; max-width: var(--field-width, 520px); }

/* 視覚的に隠す（フォーム送信用にDOMは残す） */
.u-vh {
  position:absolute !important; width:1px !important; height:1px !important;
  padding:0 !important; margin:-1px !important; overflow:hidden !important;
  clip:rect(0 0 1px 1px) !important; white-space:nowrap !important; border:0 !important;
}

/* カスタム・ドロップダウン */
.mood-select{ position:relative; display:block; width:100%; max-width: var(--field-width, 520px); }
.mood-trigger {
  display:flex; justify-content:center; align-items:center; gap:8px; /* ← display:center は無効 */
  width:100%; height:40px;
  padding:8px 10px; border:1px solid #ccc; border-radius:6px; background:#fff; cursor:pointer;
}
.mood-trigger .mood-dot{
  width:16px; height:16px; border-radius:50%; background: var(--c, transparent);
}
.mood-panel{
  position:absolute; top:calc(100% + 6px); z-index:2000;
  left:50%; transform: translateX(-50%);
  width: min(100%, 320px);           /* 必要に応じてパネル幅 */
  max-width: calc(100vw - 24px);
  box-sizing:border-box;
  background:#fff; border:1px solid #ddd; border-radius:8px;
  box-shadow:0 8px 24px rgba(0,0,0,.12);
  padding:12px 16px;
  display:flex;
  flex-direction: column;
  align-items: center;               /* 水平中央 */
  justify-content: center;           /* 垂直中央 */
  gap:8px;
  min-height: 160px;
}
.mood-panel[hidden] { display: none !important; }
.mood-option{
  display:grid;
  justify-content:center;
  place-items:center;
  width:100%;
  height:40px;
  border-radius:6px; background:#fff; border:1px solid transparent; cursor:pointer;
  line-height:0;
  font-size:0;
}
.mood-option .mood-dot{
  display:block;
  margin:auto;              
  width:14px; height:14px;
  border-radius:50%;
  background: var(--c);
}
.mood-option[aria-selected="true"]{
  background:#f2f6ff; border-color:#cfe0ff;
}
.mood-option:hover{ background:#f7f7f7; }
.mood-trigger.is-chosen .mood-label { display: none; }
.mood-trigger.is-chosen { gap: 0; }

</style>



{% if reset_photo %}
<script>window.RESET_UPLOAD = true;</script>
{% else %}
<script>window.RESET_UPLOAD = false;</script>
{% endif %}



<!-- =========================
     5) ページ専用スクリプト
========================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  /* ================================
 * 5-1) 写真プレビュー（未登録→新規選択時）
 * ================================ */
  const input     = document.getElementById("photo-input");
  const wrap      = document.getElementById("photo-preview-wrap");
  const img       = document.getElementById("photo-preview");
  const actions   = document.getElementById("photo-new-actions");
  const removeBtn = document.getElementById("btn-remove-photo");
  const reselect  = document.getElementById("photo-reselect");
  const sel = document.getElementById("mood");
  const noteEl = document.getElementById("{{ form.note.id_for_label }}");
  if (noteEl) noteEl.placeholder = "（例）今日の気分の理由や出来事などを書いてみてください";

  const closePreview = () => {
    if (img) {
      img.removeAttribute("src");
    }
    if (wrap) {
      wrap.classList.remove("is-open");
      wrap.setAttribute("aria-hidden", "true");
      wrap.style.removeProperty("display");
    }
    if (actions) actions.style.removeProperty("display");
    if (input) input.style.display = "block";
  };

  const openPreview = (file) => {
    if (!file) return closePreview();
    if (img) {
      img.src = URL.createObjectURL(file);
    }
    if (wrap) {
      wrap.classList.add("is-open");
      wrap.setAttribute("aria-hidden", "false");
      wrap.style.removeProperty("display");
    }
    if (actions) actions.style.removeProperty("display");
    if (input) input.style.display = "none";
  };

  if (window.RESET_UPLOAD) {
    if (input) input.value = "";
    if (reselect) reselect.value = "";
    closePreview();
  }

  if (wrap) closePreview();
  const initialFile = (input && input.files && input.files[0]) ? input.files[0] : null;
  if (initialFile) openPreview(initialFile);

  if (input) {
    input.addEventListener("change", () => {
      const file = (input.files && input.files[0]) ? input.files[0] : null;
      if (file) openPreview(file);
      else closePreview();
    });
  }

  // 写真削除：全部クリア、閉じる
  if (removeBtn) {
    removeBtn.addEventListener("click", () => {
      if (input)    input.value = "";
      if (reselect) reselect.value = "";
      closePreview();
    });
  }

  // 写真変更
  if (reselect) {
    reselect.addEventListener("change", () => {
      const file = (reselect.files && reselect.files[0]) ? reselect.files[0] : null;
      if (!file || !input) return;
      const dt = new DataTransfer();
      dt.items.add(file);
      input.files = dt.files; 
      openPreview(file);
    });
  }


  /* ================================
   * 5-2) 気分セレクト：色反映
   * ================================ */
  (function(){
    const sel = document.getElementById("mood");
    const root = document.querySelector('[data-enhance="mood"]');
    if (!sel || !root) return;

    const trigger = root.querySelector('.mood-trigger');
    const panel   = root.querySelector('.mood-panel');
    const labelEl = trigger.querySelector('.mood-label');
    const dotEl   = trigger.querySelector('.mood-dot');
    const opts    = [...panel.querySelectorAll('.mood-option')];

    // ネイティブselectは視覚的に隠す（送信用に残す）
    sel.classList.add('u-vh');

    // value→color 逆引き
    const val2color = new Map(
      [...sel.options].map(o => [o.value, o.dataset.color || ""])
    );

    function apply(val){
      // セレクト更新
      sel.value = val || "";
      // トリガー表示更新
      const color = val2color.get(sel.value) || "";
      dotEl.style.setProperty('--c', color || 'transparent');

      const txt = (() => {
        if (!sel.value) return '選択してください';
        const o = [...sel.options].find(o => o.value === sel.value);
        return (o && (o.textContent || o.innerText)) || '色';
      })();
      labelEl.textContent = "";

      // リストの選択表示
      opts.forEach(b => b.setAttribute('aria-selected', b.dataset.value === sel.value ? 'true' : 'false'));

      // ラベルと見た目（未選択→文言、選択後→ラベル非表示）
      if (!sel.value) {
        labelEl.textContent = '色を選択してください（必須）';
        trigger.classList.remove('is-chosen');
      } else {
        labelEl.textContent = ''; // テキストは消す（●だけ見せる）
        trigger.classList.add('is-chosen');
      }

      // 他の処理と連動させたい
      sel.dispatchEvent(new Event('change', {bubbles:true}));
    }

    // 開閉
    function open(){ panel.hidden = false; trigger.setAttribute('aria-expanded','true'); }
    function close(){ panel.hidden = true; trigger.setAttribute('aria-expanded','false'); }
    function toggle(){ (panel.hidden ? open : close)(); }

    trigger.addEventListener('click', toggle);
    document.addEventListener('click', (e) => {
      if (!root.contains(e.target)) close();
    });

    // 選択
    opts.forEach(b => {
      b.addEventListener('click', () => { apply(b.dataset.value || ""); close(); });
    });

    // 初期状態
    apply(sel.value || "");

    // もし外部でselectが書き換わった時も同期
    sel.addEventListener('change', () => apply(sel.value || ""));
  })();

  /* ================================
   * 5-3) 既存写真の削除モーダル（右カラム）
   * ================================ */
  document.querySelectorAll('[data-photo-delete]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const m = document.getElementById('photo-delete-modal');
      if (!m) return;
      m.classList.add('show');
      m.setAttribute('aria-hidden','false');
      const f = document.getElementById('photo-delete-form');
      if (f) f.action = window.location.href;
    });
  });
});

/* ================================
 * 5-4) 気分説明モーダル open/close（グローバル）
 * ================================ */
function openMoodModal() {
  const moodModal = document.getElementById("moodModal");
  if (!moodModal) return;
  moodModal.classList.add("show");
  moodModal.setAttribute("aria-hidden", "false");
}
function closeMoodModal() {
  const moodModal = document.getElementById("moodModal");
  if (!moodModal) return;
  moodModal.classList.remove("show");
  moodModal.setAttribute("aria-hidden", "true");
}

document.addEventListener("DOMContentLoaded", () => {
  // 写真変更で選んだファイルに反映
  const existingInput = document.getElementById("photo-input-existing");
  const existingImg   = document.querySelector(".current-photo .cp-img");

  if (existingInput && existingImg) {
    existingInput.addEventListener("change", () => {
      const file = existingInput.files && existingInput.files[0];
      if (!file) return;

      // 画像即時プレビュー
      const url = URL.createObjectURL(file);
      existingImg.src = url;
      existingImg.style.display = "block";
      existingImg.onload = () => URL.revokeObjectURL(url);
    });
  }
});
</script>
{% endblock %}
